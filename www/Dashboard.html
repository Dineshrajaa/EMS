<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Dashboard | EMS</title>
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script src="js/jquery-ui.min.js" type="text/javascript"></script>
    <script src="js/jquery.mobile.min.js" type="text/javascript"></script>
    <script src="js/waves.min.js" type="text/javascript"></script>
    <script src="js/nativedroid2.js" type="text/javascript"></script>
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="css/jquery.mobile.min.css" />
    <link rel="stylesheet" href="css/themeContainer.css" />
    <link rel="stylesheet" href="css/common.css" />
    <link rel="stylesheet" href="css/waves.min.css" />
    <style type="text/css">
        .ui-input-text::after, .ui-input-search::after
        {
            width: 80% !important;
        }
    </style>
</head>
<body>
    <div id="container">
        <div data-role="page" id="pgdashboard" data-theme="a" class="nd2-no-menu-swipe registration">
            <nd2-include data-src="Menu.html"></nd2-include>
            <div data-role="header" data-position="fixed">
                <h1 class="wow fadeIn" data-wow-delay='0.4s'>
                    Status
                </h1>
                <a href="#leftpanel" class="ui-btn ui-btn-left menu"><i class="zmdi zmd-2x zmdi-menu">
                </i></a>
            </div>
            <div role="main" class="ui-content wow fadeIn" data-inset="false">
                <div class="nd2-card" style="padding: 5px; border-radius: 15px; text-align: center">
                    <h4>
                        <b>Current Status: <span id="curStatus"></span></b>
                    </h4>
                    <hr />
                    <div class="ui-controlgroup-label" role="heading">
                        <h4 style="color: #666666">
                            <b>Change tomorrows work availability status to:</b>
                        </h4>
                    </div>
                    <div class="ui-controlgroup-controls" style="padding-left: 36%">
                        <label for="radio-choice-ab">
                            Available to work
                            <input id="rdAvail" type="radio" value="2" name="rdChngeSts" class="rdio">
                        </label>
                        <label for="radio-choice-bb">
                            Not Available
                            <input id="rdNtAvail" type="radio" value="3" name="rdChngeSts" class="rdio">
                        </label>
                    </div>
                    <!-- <br/>
                <h4>
                    --OR--</h4>
                <div style="text-align: left">
                    <label for="txtDob">
                        I am not available untill
                    </label>
                    <input type="text" id="txtDob" name="txtDob" class="" placeholder="DD/MM/YYYY"/>
                </div>-->
                </div>
                <!--<a href="#" id="btnCancelDP">Click Here</a>
            <a href='#popupDialog' data-rel='popup' data-position-to='window' data-role='button' data-icon='external-link' data-transition='pop' data-inline='true'>Open popup dialog</a>-->
                <div class="nd2-card jobSection" style="padding: 5px; border-radius: 15px; text-align: center">
                    <div class="ui-controlgroup-label" role="heading">
                        <h4>
                            <b>Current Job</b></h4>
                        <hr />
                    </div>
                    <div id="currentJob" class="ui-controlgroup-label">
                        <table data-role="table" id="tblJobsList" data-mode="" class="ui-responsive table-stroke">
                            <tbody>
                                <tr>
                                    <td>
                                        Client :
                                    </td>
                                    <td id="spnClient">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Project :
                                    </td>
                                    <td id="spnProject">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Project Address :
                                    </td>
                                    <td id="spnProjAddress">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Start Date :
                                    </td>
                                    <td id="spnStartDate">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Message :
                                    </td>
                                    <td id="spnMessage">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div style="padding: 5px; border-radius: 15px; text-align: center" class="jobSection">
                    <a href="#" onclick=" redirect('Jobs.html') " class="ui-btn ui-btn-raised clr-primary">
                        View Jobs</a>
                    <br />
                </div>
                <!--<div data-role='popup' id='popupDialog' data-theme='b'>
                <div data-role='header' data-theme='b'>
                    <h1>Delete from library?</h1>
                </div>
                <div data-role='content' data-theme='b'>
                    <p>This is a popup description...</p>
                    <div class='showastabs center nobg'>
                        <a href='#' data-rel='back' data-icon='ok' data-iconpos='left' data-role='button' data-inline='true'>Okay</a>
                        <a href='#' data-rel='back' data-icon='delete' data-iconpos='left' data-role='button' data-inline='true'>Cancel</a>
                    </div>
                </div>
            </div>-->
            </div>
            <div data-role="popup" id="popupDialog" style="border-radius: 10px; max-width: 300px;"
                data-dismissible="true" data-overlay-theme="a" data-theme="a" data-position-to="origin">
                <!--<div data-theme="a" role="banner" data-role="header">
                    <h1 class="ui-title" role="heading">
                    Status Change</h1>
                </div>-->
                <div role="main" class="ui-content wow fadeIn" data-inset="false" style="padding-bottom: 20px !important;
                    text-align: center;">
                    <h3 class="ui-title" style="padding-top: 15px;" role="heading">
                        Status Change</h3>
                    <span style="padding-top: 15px;">Changing your status will notify office staff of your
                        availability to work. If you are already working this means you wont be continuing
                        in the future.</span>
                    <br />
                    <h4>
                        <b>Do you wish to continue?</b>
                    </h4>
                    <a style="background: #db3535;" class="popupButton" data-theme="a" data-inline="true"
                        data-role="button" href="#" data-corners="true" data-rel="back">Cancel</a> <a style="background: #3498db;"
                            class="popupButton" data-theme="a" data-inline="true" onclick="updateWorkStatus()"
                            data-role="button" href="#" data-corners="true">Continue</a>
                    <br />
                </div>
            </div>
        </div>
    </div>
    <script src="js/common.js" type="text/javascript"></script>
    <link href="css/mobiscroll.frame.css" rel="stylesheet" type="text/css" />
    <link href="css/mobiscroll.frame.android-holo.css" rel="stylesheet" type="text/css" />
    <link href="css/mobiscroll.scroller.css" rel="stylesheet" type="text/css" />
    <link href="css/mobiscroll.android-holo-light.css" rel="stylesheet" type="text/css" />
    <!--   Date Picker and Time picker files Start-->
    <script src="js/mobiscroll.core.js" type="text/javascript"></script>
    <script src="js/mobiscroll.frame.js" type="text/javascript"></script>
    <script src="js/mobiscroll.scroller.js" type="text/javascript"></script>
    <script src="js/mobiscroll.util.datetime.js" type="text/javascript"></script>
    <script src="js/mobiscroll.datetimebase.js" type="text/javascript"></script>
    <script src="js/mobiscroll.datetime.js" type="text/javascript"></script>
    <script src="js/mobiscroll.android-holo-light.js" type="text/javascript"></script>
    <!--   Date Picker and Time picker files End-->
    <script type="text/javascript">
        var selectedValue = 0;
        $(document).on("ready", function () {
            var currentUserObj = localStorage.getItem('userSession');

            if (currentUserObj && currentUserObj != 'undefined') {
                var currentUser = JSON.parse(currentUserObj);
                var url = serviceUrl + "Account/GetUserStatus";
                var obj = {};
                obj.id = parseInt(currentUser.ID);
                showWait();
                $.ajax({
                    type: "GET",
                    url: url,
                    data: obj,
                    async: false,
                    success: function (result) {
                        if (result.IsSuccessful) {
                            currentUser.JobStatusType = result.Result;
                            localStorage.setItem('userSession', JSON.stringify(currentUser));
                            if (result.Result == "1" || result.Result == 1) {
                                $("#curStatus").html("Working");
                                $("#curStatus").removeClass('available').removeClass('notAvailable').addClass('working');
                                $("#rdAvail").attr("checked", false);
                                $("#rdAvail").prev().removeClass("ui-radio-on");
                                $("#rdNtAvail").attr("checked", false);
                                $("#rdNtAvail").prev().removeClass("ui-radio-on");
                                $(".jobSection").show();
                                GetAssignJob();
                            }
                            if (result.Result == "2" || result.Result == 2) {
                                $("#rdAvail").attr("checked", true);
                                $("#rdAvail").prev().removeClass("ui-radio-off").addClass("ui-radio-on");
                                $("#curStatus").html("Available");
                                $("#curStatus").removeClass('working').removeClass('notAvailable').addClass('available');
                                $(".jobSection").show();
                                $("#currentJob").html("");
                                $("#currentJob").append("<h4>There are no current jobs</h4>");
                            }
                            if (result.Result == "3" || result.Result == 3) {
                                $("#rdNtAvail").attr("checked", true);
                                $("#rdNtAvail").prev().removeClass("ui-radio-off").addClass("ui-radio-on");
                                $("#curStatus").html("Not Available");
                                $("#curStatus").removeClass('working').removeClass('available').addClass('notAvailable');
                                $(".jobSection").hide();
                            }
                        }
                        hideWait();
                    },
                    error: function (err) {
                        hideWait();
                        toast("Network Error");
                    }
                });
                //alert(currentUser.JobStatusType);
                //                if (currentUser.JobStatusType == "1" || currentUser.JobStatusType == 1) {
                //                    $("#curStatus").html("Working");
                //                    $("#curStatus").removeClass('available').removeClass('notAvailable').addClass('working');
                //                }
                //                if (currentUser.JobStatusType == "2" || currentUser.JobStatusType == 2) {
                //                    $("#rdAvail").attr("checked", true);
                //                    $("#rdAvail").prev().removeClass("ui-radio-off").addClass("ui-radio-on");
                //                    $("#curStatus").html("Available");
                //                    $("#curStatus").removeClass('working').removeClass('notAvailable').addClass('available');
                //                }
                //                if (currentUser.JobStatusType == "3" || currentUser.JobStatusType == 3) {
                //                    $("#rdNtAvail").attr("checked", true);
                //                    $("#rdNtAvail").prev().removeClass("ui-radio-off").addClass("ui-radio-on");
                //                    $("#curStatus").html("Not Available");
                //                    $("#curStatus").removeClass('working').removeClass('available').addClass('notAvailable');
                //                }
            } else {
                doLogout();
            }

            $('.rdio').click(function () {
                //var cnfrm = confirm('Changing your status will notify management of your availability. Do you wish to continue?');
                $('#popupDialog').popup("open");
                selectedValue = this.value;

                //                if (cnfrm != true) {
                //                    this.checked = false;
                //                    return false;
                //                }
                //                else {
                //                    var val = this.value;
                //                    if (currentUser.JobStatusType != val) {
                //                        currentUser.JobStatusType = val;
                //                        localStorage.setItem('userSession', JSON.stringify(currentUser));
                //                        UpdateStatus(val);
                //                    }
                //                    this.checked = true;
                //                    return true;
                //                }
            });

            
        });

        function updateWorkStatus() {
            $('#popupDialog').popup("close");
            var currentUserObj = localStorage.getItem('userSession');

            if (currentUserObj && currentUserObj != 'undefined') {
                var currentUser = JSON.parse(currentUserObj);
                if (currentUser.JobStatusType != selectedValue) {
                    currentUser.JobStatusType = selectedValue;
                    localStorage.setItem('userSession', JSON.stringify(currentUser));
                    UpdateStatus(selectedValue);
                }


            }
        }

        function UpdateStatus(statusId) {
            showWait();
            var currentUserObj = localStorage.getItem('userSession');
            var currentUser = JSON.parse(currentUserObj);
            var url = serviceUrl + "Account/UpdateUserJobStatus";
            var jsonObj = new Object();
            jsonObj.userId = currentUser.ID;
            jsonObj.statusId = statusId;
            jsonObj.updatedByUserId = currentUser.ID;
            $.ajax({
                type: "GET",
                url: url,
                data: jsonObj,
                async: false,
                success: function (result) {
                    if (result.IsSuccessful) {
                        if (result.Result) {
                            if (statusId == "2") {
                                $("#curStatus").html("Available");
                                $("#curStatus").removeClass('working').removeClass('notAvailable').addClass('available');
                                $(".jobSection").show();
                                $("#currentJob").html("");
                                $("#currentJob").append("<h4>There are no current jobs</h4>");
                            }
                            if (statusId == "3") {
                                $("#curStatus").html("Not Available");
                                $("#curStatus").removeClass('working').removeClass('available').addClass('notAvailable');
                                $(".jobSection").hide();
                            }
                            toast("Status Changed.");
                        }
                    }
                },
                error: function (err) {
                    hideWait();
                    toast("Network Error");
                }
            });
        }

        //        $(function () {
        //           $('#txtDob').mobiscroll().date({
        //                lang: 'en',
        //                theme: 'android-holo-light',
        //                display: 'bubble',
        //                display: 'bottom',
        //                dateOrder: 'ddMMyy',
        //                dateFormat: 'DD MM yy',
        //                mode: 'scroller'
        //            });
        //        });
    </script>
</body>
</html>
